---
id: SPEC-023
title: Codex app-server protocol types and upgrade workflow (TS-only artifacts)
status: Completed
date: 2026-01-23
related_adrs:
  - docs/adr/0013-codex-app-server-protocol-types.md
  - docs/adr/0002-model-backends.md
  - docs/adr/0006-testing-vitest.md
  - docs/adr/0008-security.md
related_specs:
  - docs/specs/020-codex-backends.md
related_docs:
  - docs/codex-app-server-protocol.md
  - docs/research/codex-0.89.0-delta.md
  - packages/codex-app-server-protocol/README.md
upstream_docs:
  - https://developers.openai.com/codex/app-server/
  - https://developers.openai.com/codex/cli/reference/
  - opensrc/repos/github.com/openai/codex/codex-rs/app-server/README.md
---

## Goal

Provide a strict, reproducible contract for Codex app-server v2 that is:

- version-pinned to the installed Codex CLI
- strongly typed (TypeScript generated by Codex)
- safe at runtime (JSON-RPC envelope validation)
- low-churn (no committed JSON Schema bundle unless explicitly required)

## Non-goals

- Supporting multiple Codex protocol versions simultaneously.
- Defining the protocol surface manually (use upstream generators).
- Validating every payload field at runtime (envelope-only validation for now).

## Terminology

- **Codex CLI version**: `@openai/codex` version pinned in the repo root.
- **Protocol types**: the TypeScript output of `codex app-server generate-ts`.
- **Schema bundle**: JSON Schema output of `codex app-server generate-json-schema`.
- **Postprocess**: deterministic rewrite that adds `.js` extensions for NodeNext.

## Source of truth

1. Codex-generated TypeScript protocol types committed in:
   - `packages/codex-app-server-protocol/src/generated/`
2. Upstream docs + open-source app-server implementation for semantics.

JSON Schema bundles are generated but **not committed**. They live under
`tools/codex-schemas/` and are ignored by git.

## Directory layout

### Protocol package

`packages/codex-app-server-protocol/` is a workspace package that contains:

- `src/generated/` (Codex-generated TS types)
- `src/index.ts` (explicit re-exports)
- `index.js` (runtime stub to satisfy Node ESM resolution)

### JSON Schema output (ignored)

Generated into:

- `tools/codex-schemas/app-server-protocol/` (gitignored)

## Generation commands

Run from repo root:

```bash
pnpm install
pnpm codex:gen
```

This runs:

1. `codex app-server generate-ts --out packages/codex-app-server-protocol/src/generated`
2. `node scripts/codex-app-server-protocol-postprocess.mjs`
3. `codex app-server generate-json-schema --out tools/codex-schemas/app-server-protocol`

## Postprocess details

`moduleResolution: "NodeNext"` requires explicit extensions in relative imports.

`scripts/codex-app-server-protocol-postprocess.mjs` rewrites generated files to:

- append `.js` to extensionless relative imports
- rewrite bare directory specifiers to `/index.js`

## Commit policy (definitive)

1. **Commit** TypeScript protocol artifacts.
2. **Do not commit** JSON Schema bundles.
3. Do not hand-edit generated files; regenerate instead.
4. Keep only the latest pinned Codex version's artifacts.

## Runtime validation

We validate JSON-RPC **envelopes** with Zod in:

- `packages/codex/src/app-server/schema.ts`

This is a safety layer that rejects malformed envelopes while keeping forward
compatibility for new fields. Full JSON Schema validation can be reintroduced if
we later need tighter runtime guarantees.

## Upgrade workflow

When upgrading the Codex CLI/app-server protocol:

1. Bump `@openai/codex` in the root `package.json`.
2. Run `pnpm install`.
3. Regenerate protocol artifacts:

   ```bash
   pnpm codex:gen
   ```

4. Review diffs in `packages/codex-app-server-protocol/src/generated/`.
5. Update app-server integration code for new protocol surfaces:

   - `packages/codex/src/app-server/**`
   - `packages/codex/src/app-server-backend.ts`

6. Update docs and tests for any deltas.
7. Verify:

   ```bash
   pnpm -s fix:typecheck
   ```

## CI gate

CI must run:

```bash
pnpm -s codex:gen:check
```

This ensures the committed TypeScript artifacts match the pinned Codex version.

## Required invariants

- The repo uses the workspace-local `codex` binary (no global dependency).
- Tests do not spawn real Codex processes (ADR-0006).
- No production code manually duplicates generated protocol types.
- JSON Schema bundles are reproducible but ignored by git.

## Files touched during upgrades (checklist)

- `package.json` (bump `@openai/codex`)
- `pnpm-lock.yaml`
- `packages/codex-app-server-protocol/src/generated/**`
- `packages/codex/src/app-server/**`
- `tests/unit/**` for protocol-specific behavior
- `docs/` updates (this SPEC + related ADRs/guides)
