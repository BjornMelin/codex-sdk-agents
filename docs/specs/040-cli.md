# SPEC 040: Codex ToolLoop CLI (commands, streaming UX, sessions, run artifacts)

You are implementing `apps/cli` into a usable local CLI tool.

## Objectives

1. Add command routing with subcommands:
   - `doctor`
   - `mcp start`
   - `run spec <path>`
   - `run workflow <name>`
   - `session list`
   - `session inspect <runId>`
2. Implement streaming output:
   - show assistant text deltas
   - show normalized events (tool, command, file change)
3. Implement run directory management:
   - create new run directory for each run
   - print path at start and end
4. Implement session persistence:
   - record codex thread IDs per run
   - allow `codex-toolloop session list` to show runs and thread IDs

## Hard requirements

- Node.js v24 LTS runtime (ADR 0001).
- No heavy CLI framework required, but you may use a minimal one if it reduces complexity.
- Must be cross-platform enough for macOS/Linux/WSL.

## Command behavior

### codex-toolloop doctor

- Already created in bootstrap, now improve:
  - checks `codex` presence
  - checks Codex login presence:
    - best effort: detect `~/.codex` existence and either auth.json or keyring usage cannot be detected reliably, so print guidance
  - checks MCP server ports availability if configured

### codex-toolloop mcp start

- Starts first-party MCP HTTP server(s).
- Prints:
  - server URLs
  - tool count
- Supports `--port` and `--daemon` (daemon can be a simple "keep-alive"; no full service manager required).

### codex-toolloop run spec `<path>`

- Loads the spec file content and uses the “feature-dev workflow” to implement it.
- Stores spec content into the run directory.

### codex-toolloop run workflow `<name>`

- Executes a named workflow from `packages/workflows`.
- Supports `--backend app-server|exec|sdk`.
- Supports policies:
  - `--approval on-failure|on-request|never|untrusted`
  - `--sandbox read-only|workspace-write|danger-full-access`

### codex-toolloop session list

- Lists runs from the artifact store index.
- Prints:
  - runId
  - createdAt
  - backend
  - threadId (if present)
  - status (completed/failed)

### codex-toolloop session inspect `<runId>`

- Prints:
  - final report
  - location of logs
  - last events tail

## Run directory format

Inside `~/.codex-toolloop/runs/<runId>/`:

- `meta.json`
- `events.jsonl`
- `codex-events.jsonl` (if available)
- `tool-calls.jsonl`
- `spec.md` (if spec run)
- `final-report.md`

Also create an index file:

- `~/.codex-toolloop/index.jsonl` appended per run meta.

## Streaming UX (minimum)

- Print text deltas as they arrive.
- Print event lines prefixed, for example:
  - `[tool] repo.ripgrep ...`
  - `[cmd] pnpm test ...`
  - `[file] src/foo.ts modified`
- At end, print:
  - “Run completed”
  - path to run artifacts
  - threadId

## Testing

- Add CLI tests that:
  - run `codex-toolloop doctor` in a controlled environment
  - run `codex-toolloop run workflow demo` with mocked codex backend and ensure run directory created

Use `packages/testkit` to create temp HOME directory and set `HOME` env var during test.

## Acceptance criteria

1. CLI commands function and exit codes are correct.
2. Run artifacts are created and indexed.
3. Streaming output appears during runs.
4. Tests pass.
